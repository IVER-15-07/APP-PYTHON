name: Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # ----------------------------------------------------------------
      # ZONA DEL BACKEND
      # ----------------------------------------------------------------
      - name: Build Backend (Verificación)
        working-directory: Backend  # <--- Asegúrate que tu carpeta en GitHub se llama así
        run: |
          npm ci
          # El flag --if-present evita el error si no tienes script de build
          npm run build --if-present 

      - name: Deploy Backend to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_API_KEY }}
        working-directory: Backend
        run: |
          # AQUÍ ESTÁ LA CLAVE: --service "backend"
          railway up --service "backend" --detach

      # ----------------------------------------------------------------
      # ZONA DEL FRONTEND
      # ----------------------------------------------------------------
      - name: Build Frontend (Construcción)
        working-directory: Frontend # <--- Asegúrate que tu carpeta en GitHub se llama así
        run: |
          npm ci
          npm run build

      - name: Deploy Frontend to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_API_KEY }}
        working-directory: Frontend
        run: |
          # AQUÍ ESTÁ LA CLAVE: --service "frontend"
          railway up --service "frontend" --detach