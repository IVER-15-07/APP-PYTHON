// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RegistroPendiente {
  id             Int      @id @default(autoincrement())
  email          String
  nombre         String
  contrasenaHash String
  rol_usuarioId  Int
  code           String
  expira         DateTime
  usado          Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([email])
}

model Usuario {
  id               Int       @id @default(autoincrement())
  nombre           String
  email            String    @unique
  contrasena       String? // null cuando provider != 'local'
  provider         String    @default("local") // 'local' o 'firebase'
  profilePicture   String?
  firebaseUid      String?   @unique
  verificado       Boolean   @default(false)
  emailToken       String?   @unique
  emailTokenExpira DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  rol_usuarioId Int?
  rol_usuario   Rol_usuario? @relation(fields: [rol_usuarioId], references: [id])

  registro     Registro[]
  calificacion Calificacion[]
  solicitudRol solicitudRol[]
}

model solicitudRol {
  id              Int      @id @default(autoincrement())
  estado          String   @default("pendiente") // pendiente, aprobado, rechazado
  fecha_solicitud DateTime @default(now())

  usuario       Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId     Int         @unique
  rol_usuario   Rol_usuario @relation(fields: [rol_usuarioId], references: [id], onDelete: Cascade)
  rol_usuarioId Int
}

model Rol_usuario {
  id           Int            @id @default(autoincrement())
  nombre       String         @unique
  usuario      Usuario[]
  solicitudRol solicitudRol[]
}

model Grupo {
  id          Int      @id @default(autoincrement())
  titulo      String
  descripcion String
  fecha_ini   DateTime @default(now())
  fecha_fin   DateTime @default(now())
  codigo      Int?     @unique

  esAprobado Boolean @default(false)

  curso   Curso @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  cursoId Int

  grupo_topico Grupo_Topico[]
  registro     Registro[]
}

model Registro {
  id             Int      @id @default(autoincrement())
  fecha_registro DateTime @default(now())

  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId Int
  grupo     Grupo   @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  grupoId   Int

  @@unique([usuarioId, grupoId])
}

model Grupo_Topico {
  id Int @id @default(autoincrement())

  grupo   Grupo? @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  grupoId Int?

  topico   Topico? @relation(fields: [topicoId], references: [id], onDelete: Cascade)
  topicoId Int?

  estado   Estado? @relation(fields: [estadoId], references: [id], onDelete: Cascade)
  estadoId Int?
}

model Curso {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique
  descripcion String?

  nivel Nivel[]
  grupo Grupo[]
}

model Nivel {
  id     Int    @id @default(autoincrement())
  nombre String

  curso   Curso @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  cursoId Int

  topico Topico[]
}

model Estado {
  id     Int    @id @default(autoincrement())
  nombre String @unique

  calificacion Calificacion[]
  grupo_topico Grupo_Topico[]
}

model Calificacion {
  id   Int @id @default(autoincrement())
  nota Int

  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId Int

  topico   Topico @relation(fields: [topicoId], references: [id], onDelete: Cascade)
  topicoId Int

  estado   Estado @relation(fields: [estadoId], references: [id], onDelete: Cascade)
  estadoId Int
}

model Topico {
  id       Int     @id @default(autoincrement())
  nombre   String

  tipo_topico   Tipo_topico @relation(fields: [tipo_topicoId], references: [id], onDelete: Cascade)
  tipo_topicoId Int
  nivel         Nivel       @relation(fields: [nivelId], references: [id], onDelete: Cascade)
  nivelId       Int

  calificacion Calificacion[]
  recursos     Recursos[]
  evaluacion   Evaluacion[]
  grupo_topico Grupo_Topico[]
}

model Tipo_topico {
  id     Int    @id @default(autoincrement())
  nombre String @unique

  topico Topico[]
}

model Recursos {
  id        Int     @id @default(autoincrement())
  nombre    String
  url       String
  audiourl  String?
  subtitulo String?
  imagenurl String?
  publicId  String?

  topico   Topico @relation(fields: [topicoId], references: [id], onDelete: Cascade)
  topicoId Int

}


model Evaluacion {
  id                 Int     @id @default(autoincrement())
  evaluacion         String
  descripcion        String?
  puntaje_evaluacion Int

  fecha_ini DateTime? @default(now())
  fecha_fin DateTime? @default(now())

  topico   Topico @relation(fields: [topicoId], references: [id], onDelete: Cascade)
  topicoId Int

  tipo_evaluacion   Tipo_evaluacion @relation(fields: [tipo_evaluacionId], references: [id], onDelete: Cascade)
  tipo_evaluacionId Int

  evaluacion_pregunta Evaluacion_pregunta[]
}

model Tipo_evaluacion {
  id     Int    @id @default(autoincrement())
  nombre String @unique

  evaluacion Evaluacion[]
}

model Evaluacion_pregunta {
  id Int @id @default(autoincrement())

  evaluacion   Evaluacion @relation(fields: [evaluacionId], references: [id], onDelete: Cascade)
  evaluacionId Int

  pregunta   Pregunta @relation(fields: [preguntaId], references: [id], onDelete: Cascade)
  preguntaId Int

 
}

model Pregunta {
  id       Int    @id @default(autoincrement())
  pregunta String

  parametro  Parametro @relation(fields: [parametroId], references: [id], onDelete: Cascade)
  parametroId Int

  evaluacion_pregunta Evaluacion_pregunta[]
  respuesta           Respuesta[]
}

model Respuesta {
  id        Int    @id @default(autoincrement())
  puntaje   Int
  respuesta String

  pregunta   Pregunta @relation(fields: [preguntaId], references: [id], onDelete: Cascade)
  preguntaId Int
}

model Parametro {
  id        Int    @id @default(autoincrement())
  nombre    String @unique

  pregunta Pregunta[]
}
